---
title: "UN_Linked"
output: html_document
date: "2025-06-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Packages 

```{r}
library(dplyr)
library(readr)
```

# Verify the structure of the original .ped file

```{r}
# Define the file path
Original_HS_ped_path <- "/Users/huncho/Desktop/Forensic_Kinship/94_SNP_Simulation/HS_Simulation/Input_Files/HSvUN_94.ped"

# Load the Linked file
Original_HS_ped <- read_delim(Original_HS_ped_path, delim = "\t", col_names = FALSE)

# Display structure of the file as a spreadsheet-style data viewer 
View(Original_HS_ped)
```

# Manipulate the original .ped file to force unrelatedness
# Break the familial relationships by setting columns 3 (Mother ID) and 4 (Father ID) to 0.

```{r}
# Set X3 and X4 (mother and father IDs) to 0 to break any pedigree structure
Unrelated_HS_ped <- Original_HS_ped %>%
  mutate(X3 = 0, 
         X4 = 0)

# Save the modified, unrelated dataset as a new .ped file
write_delim(
  Unrelated_HS_ped,
  "/Users/huncho/Desktop/Forensic_Kinship_Project/HS_Simulation/Original_Files/HSvUN_94_UN.ped",
  delim = "\t",
  col_names = FALSE
)

# Display structure of the files to confirm manipulation
View(Unrelated_HS_ped)
```

# Code to run the Merlin Simulation for UN_Linked which requires: 
# 1) Defining the path to the 4 input files: .freq, unrelated .ped, .map, .dat
# 2) Setting the random seed
# 3) Setting the number of re-runs/iterations
# 4) Saving the intermediate files and lnlikelihoods produced

```{bash}
merlin -p ../Original_Files/HSvUN_94_UN.ped -d ../Original_Files/Markers_ForenSeq_SNP.dat -m ../Original_Files/Linked_ForenSeqSNP.map -f ../Original_Files/WBFreq_94_SNPs_FamLink.freq -r 3898 --simulate --reruns 50000 --likelihood --information --markerNames --quiet --save --prefix UN_Linked/UN_Linked > likelihoods_UN_Linked_summary.txt
```

# Verify 1st simulated .ped File

```{r}
# Define file paths
Simulated_UN_Ped1_path <- "/Users/huncho/Desktop/Forensic_Kinship/94_SNP_Simulation/HS_Simulation/UN_Linked/merlin-00003898-00001-replicate.ped"

# Load the Linked file
Simulated_UN_Ped1 <- read_delim(Simulated_UN_Ped1_path, delim = "\t", col_names = FALSE)

# Display structure of the files
View(Simulated_UN_Ped1)
```

# All 50,000 simulated .ped files need to be corrected by restoring columns 3 (Mother ID) and 4 (Father ID)
# using values from the original .ped file. This prepares the files for MERLIN analysis under the H1 (true unrelatedness) hypothesis.
# The output files are saved with a "-fixed.ped" suffix.

```{r}
# Define input, output, and reference .ped file paths
input_dir  <- "/Users/huncho/Desktop/Forensic_Kinship/94_SNP_Simulation/HS_Simulation/UN_Linked/"       
output_dir <- "/Users/huncho/Desktop/Forensic_Kinship/94_SNP_Simulation/HS_Simulation/UN_Linked/"       
orig_ped   <- "/Users/huncho/Desktop/Forensic_Kinship/94_SNP_Simulation/HS_Simulation/Input_Files/HSvUN_94.ped"

n_reps     <- 50000

# Read the original .ped file to retrieve correct X3 (Mother) and X4 (Father) values
orig <- read_delim(orig_ped, delim = "\t", col_names = FALSE, show_col_types = FALSE)
colnames(orig) <- paste0("X", seq_len(ncol(orig)))

# Loop over all 50,000 (00001 - 50000) files
# Skip if the input .ped file does not exist
for(i in seq_len(n_reps)) {
  id     <- sprintf("%05d", i)
  filename <- paste("merlin-00003898-", id, "-replicate.ped", sep = "")
  in_fn <- file.path(input_dir, filename)
  out_fn <- file.path(output_dir, paste("UN_ped", i, "-fixed.ped", sep = ""))
  
  if (! file.exists(in_fn)) {
    warning("Skipping missing file: ", in_fn)
    next
  }
  
  # Read the simulated .ped file
  sim <- read_delim(in_fn, delim = "\t", col_names = FALSE, show_col_types = FALSE)
  n_cols <- ncol(sim)
  colnames(sim) <- paste("X", 1:n_cols, sep = "")

  # Restore pedigree columns X3 and X4 for rows 4 and 5 from the original .ped file
  sim[c(4,5), c("X3","X4")] <- orig[c(4,5), c("X3","X4")]
  
  # Drop row 6 and column 100 from the simulated file
  sim_clean <- slice(sim, -6)
  sim_clean <- select(sim_clean, -X100)

  # Write the cleaned and corrected .ped file
  write_delim(sim_clean, out_fn, delim = "\t", col_names = FALSE)
  
  # View the first 3 files in the viewer for manual inspection
  if (i <= 3) {
    message("Viewing fixed PED #", i, " → ", out_fn)
    View(sim_clean)
  }
  
  # Print progress message every 1000 iterations
  if (i %% 1000 == 0) {
    message("Finished ", i, " of ", n_reps)
  }
}

# Final message when processing is complete
message("All done!")
```

# Run MERLIN to extract lnLikelihoods for TRUE Unrelated cases
# This script loops over all 50,000 manipulated .ped files and saves the lnLikelihoods to individual files.
# All extracted lnLikelihood values are also compiled into a single summary file for downstream processing.

```{bash}
$ nano UN_Linked.sh

#!/bin/bash

# Set working directories
BASE_DIR="/Users/huncho/Desktop/Forensic_Kinship/94_SNP_Simulation/HS_Simulation"
PED_DIR="$BASE_DIR/UN_Linked"
OUTPUT_DIR="$BASE_DIR/UN_Linked"
INPUT_FILES="$BASE_DIR/Input_Files"

# Define marker and frequency files
# Define random seed
MARKER_DAT="$INPUT_FILES/Markers_ForenSeq_SNP.dat"
MARKER_MAP="$INPUT_FILES/Linked_ForenSeqSNP.map"
FREQ_FILE="$INPUT_FILES/WBFreq_94_SNPs_FamLink.freq"
SEED=3898

# Prepare summary file header
OUTFILE="$OUTPUT_DIR/UN_Linked_lnlikelihoods.txt"
echo -e "replicate\tlnlikelihood" > "$OUTFILE"

# Create folder for storing individual lnLikelihood output files
LNLIKELIHOOD_DIR="$OUTPUT_DIR/UN_Linked_lnlikelihoods"
mkdir -p "$LNLIKELIHOOD_DIR"

# Loop through all 50,000 replicates (00001–50000)
for i in $(seq -f "%05g" 1 50000); do
  PED_FILE="$PED_DIR/UN_ped${i}-fixed.ped"
  LNLIKELIHOOD_FILE="$LNLIKELIHOOD_DIR/UN_ped${i}.lnlikelihood"

# Check if .ped file exists before running MERLIN

  if [[ -f "$PED_FILE" ]]; then
    echo "Running Merlin for replicate $i …"

    # Run Merlin to calculate lnlikelihood
    merlin \
      -p "$PED_FILE" \
      -d "$MARKER_DAT" \
      -m "$MARKER_MAP" \
      -f "$FREQ_FILE" \
      -r "$SEED" \
      --likelihood \
      --markerNames \
    > "$LNLIKELIHOOD_FILE" 2>&1

    # Extract the last line containing "likelihood =" from MERLIN output
    LINE=$(grep -i "likelihood.*=" "$LNLIKELIHOOD_FILE" | tail -n1)

    # Extract the numeric value after the "=" sign
    LN=$(echo "$LINE" | cut -d '=' -f 2 | xargs)

    # Append replicate ID and lnLikelihood value to the summary file
    echo -e "${i}\t${LN}" >> "$OUTFILE"

    # If .ped file does not exist, log a warning and skip
  else
    echo "WARNING: $PED_FILE not found, skipping."
  fi
done

# Final message upon completion
echo "All done!  See summary in $OUTFILE and full outputs in $LNLIKELIHOOD_DIR/"
```

```{bash}
# Make the script executable and run it
chmod +x UN_Linked.sh
./UN_Linked.sh
```